<!doctype html>
<html lang="eng">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='/favicon.ico') }}">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <style>
		body {
            background: url({{ url_for('static', filename='media/images.jpeg') }}) no-repeat fixed;
            background-size: 100% 100%;
		}
		button:hover {
			color: red !important;
		}
        .card-header{
            color: white;
            background-color: #007bff;
        }
        .card-footer{
            text-align: center;
        }
        @media all and (max-width: 550px) {
            .card {
                text-align: center;
                width: 100% !important;
                margin: 0;
                position: absolute;
                top: 50%;
                transform: translate(0%, -50%)
		    }
            #km, #est {
                margin: auto;
                width: 90%;
            }
        }
        @media all and (min-width: 551px) {
            .card {
                text-align: center;
                width: 60% !important;
                margin: 0;
                position: absolute;
                top: 50%;
                left: 20%;
                transform: translate(0%, -50%);
            }
            #km, #est {
                margin: auto;
                width: 50%;
            }
        }
	</style>
	<title>Establishment Tracker</title>
</head>
<body>
    {% with messages = get_flashed_messages(with_categories=false) %}
        {% if messages %}
            <div class="alert alert-danger alert-dismissable fade show" role="alert">
                {{ messages[-1] }}
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        {% endif %}
    {% endwith %}

	<div class="card">
		<h5 class="card-header">Establishment Tracker</h5>
		<div class="card-body">
			<p class="card-text">Establishments within entered distance are marked on the map when it loads; Default is 1km.</p>
			<p class="card-text">The establishments will be listed in order of closest to furthest.</p>
			<p class="card-text">Press the button below to enable the location tracker and select <b>Allow</b>. You will be directed to map if tracker is functional.</p>
            <select class="input-group-text" name="type" id="est">
                {% for val, name in establishments %}
                    <option value="{{ val }}">{{ name }}</option>
                {% endfor %}
            </select>
            <br>
            <input id="km" class="input-group-text" type="number" placeholder="Enter distance in km (Min 1, Max 5)" max="5" min="1">
		</div>
		<h5 class="card-footer">
			<button onClick="awaken();" class="btn btn-dark">Track Locations</button>
		</h5>
	</div>
	<script>
        function awaken() {
            if (navigator.geolocation){
                let x = 1;
                while(x<3){
                    let geo = navigator.geolocation.watchPosition(
                        () => {},
                        () => {},
                        { maximumAge: 2000, timeout: 2000, enableHighAccuracy: true }
                    );
                    window.navigator.geolocation.clearWatch(geo);
                    x += 1;
                }
                enable();
            }
            else {
                $(window).location.href = "/unsupported";
            }
        }
		function enable(){
            navigator.geolocation.getCurrentPosition(
            (position) => {
                let km = $('#km');
                let est = $('#est');
                let data = {
                    x: position.coords.latitude,
                    y: position.coords.longitude,
                    d: km.val()==='' ? 1.0 : Number.parseFloat(km.val()),
                    e: est.val()
                };

                fetch('/track', {
                    method: "POST",
                    credentials: "include",
                    body: JSON.stringify(data),
                    cache: "no-cache",
                    headers: new Headers({
                        'content-type': "application/json"
                    })
                }).then(()=>{
                    window.location.href = '/showMap';
                });
            },() => {
                enable();
            },{ maximumAge: 3000, timeout: 5000, enableHighAccuracy: true });
		}
	</script>
</body>
</html>

